---
layout: post
title: "[DevOps] - Anchore 이미지 분석 툴 사용 With Jenkins"
author: Lee Wonseok
categories: DevOps
date: 2020-12-28 12:36
comments: true
cover: "/assets/kubernets.jpg"
tags: DevOps
---



#  [DevOps] - Anchore 사용 With Jenkins
**머리말**  

**지난 포스트에서 간단하게 전체적인 파이프라인에 대해서 포스트를 했습니다.**  
**이번 포스트에서는 자동화된 파이프라인 내에서 Harbor에 올라가 배포 될 이미지의 분석 툴인**  
**Anchor를 도입하는 포스트를 작성했습니다.**


---

**전체적인 프로젝트 글들은 아래를 참고 해주시면 됩니다.**

### [1. Jenkins를 이용한 CI 구축기](https://nasa1515.github.io/devops/2020/09/22/CICD.html)
### [2. Rancher를 사용한 k8s 클러스터 구축기 - on-pre 환경](https://nasa1515.github.io/devops/2020/10/13/CICD.html)
### [3. Rancher를 사용한 k8s 클러스터 구축기 GKE](https://nasa1515.github.io/devops/2020/10/13/CICD2.html)
### [4. Argo-CD를 이용한 배포 자동화](https://nasa1515.github.io/devops/2020/10/14/CICD3.html)
### [5. 보안 취약점 검사를 위한 Dvmn 앱 배포하기!](https://nasa1515.github.io/devops/2020/10/21/CICD4.html)
### [6. GCP의 FileStore (NFS) 사용해 DB 데이터 백업](https://nasa1515.github.io/devops/2020/10/21/CICD5.html)
### [7. Jenkins로 Dvmn 앱 이미지 빌드 및 푸시하기](https://nasa1515.github.io/devops/2020/10/21/CICD6.html)
### [8. Harbor 이미지 저장소 도입](https://nasa1515.github.io/devops/2020/12/23/CICD-harbor.html)

---


* **사용 할 툴을 다음과 같습니다.**  

    - **Jenkins**
    * **Anchore**

---


**목차**

- [Anchore 설치](#a1)
- [GCP 방화벽 설정](#a2)
- [Jenkins Pipeline Script 수정](#a3)
- [파이프라인 실행 결과](#a4)

---


<br/>

### **Anchore 설치 (Docker)** <a name="a1"></a>

<br/>

**Anchore 설치와 Jenkins와 연동은 이미 많은 분들이 포스트하셨습니다.**    
**따라서 제 포스트에서는 간단하게 명령어, 이미 설치되어있다는 가정하에 정리하였습니다.**

* **설치 명령어**

    ```
    $ curl https://docs.anchore.com/current/docs/engine/quickstart/docker-compose.yaml > docker-compose.yaml
    $ docker-compose up -d

    $ yum install epel-release
    $ yum install python-pip
    $ pip install anchorecli
    ```

---


### **GCP 방화벽 설정** <a name="a2"></a>

**GCP 기반의 인프라이기 때문에 GCP의 VPN에서 설치 할 때 설정해줬던  
Anchore의 Service Port를 허용해줘야만 Jenkins에서 연동이 가능합니다.**


* **다음과 같이 Jenkins-환경설정에서 Anchore Container Image Scanner**  
    **설정의 Servic Port를 Anchore와 GCP에서 Allow 해준 Port를 기입하면 됩니다.**

    ![캡처22](https://user-images.githubusercontent.com/69498804/103250454-3b707280-49b7-11eb-95ce-220663b7dc54.PNG)



---



### **Jenkins Pipeline Script 수정** <a name="a3"></a>

**위에 있는 연동을 위한 환경설정들이 모두 마무리 되었으면**  
**아래처럼 파이프라인 스크립트내에 Anchore의 Analyse부분을 추가해줍니다.**


* **스크립트**  

    ```
            stage('Anchore analyse') {  
                steps {  
                    catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                    writeFile file: 'anchore_images', text: '34.64.237.112/cccr/jisun'  
                    anchore name: 'anchore_images'  
                    }
                }
            }
    ```


---



### **파이프라인 실행 결과** <a name="a4"></a>

**제대로 연동되었다면 파이프라인이 종료된 뒤 가시적인 로그를 볼 수 있습니다.**

* **Anchore 스캐닝 리포트**

    ![33](https://user-images.githubusercontent.com/69498804/103250671-5f808380-49b8-11eb-8ef1-c939886fde60.PNG)


---

<br/>

### **정상적인 스캐닝 여부 확인** <a name="a4"></a>