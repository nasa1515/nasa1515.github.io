---
layout: post
title: "[Dev] - MicroSoft BotFrameWork with Python to Azure 1편"
author: nasa1515
categories: DEV
date: 2021-05-12 12:36
comments: true
cover: "/assets/1800-550.jpg"
tags: DEV
---



## **MicroSoft BotFrameWork with Python to Azure 1편**


<br/>

**머리말**  

**이번 포스트도 역시 파이썬을 첨가했습니다.**  
**MicroSoft에서 제공하는 BotFramework을**  
**사용해서 간단한 질답을 하는 ChatBot을**  
**생성한 뒤 Azure Web에 배포하고, Teams App에 연동 해보겠습니다.**  

---

**DEV 시리즈**




---

**목차**

- [Microsoft BotFrameWork](#a1)
- [Bot 생성](#a2)
    - [FrameWork Bot 생성](#a3)


--- 

## **BotFrameWork** <a name="a1"></a> 

**MicroSoft에서 제공하고 있는 Chatbot SDK OpenSource 입니다.**  
**C#, JS, Python, Java 등 여러 언어를 사용해서 SDK를 사용 할 수 있고**  
**제작한 템플릿을 쉽게 Azure의 Service와 연동 할 수 있습니다.**  


* **[GITHUB](https://github.com/microsoft/botframework-sdk)**  

<br/>

---

## **1. Bot 생성** <a name="a2"></a> 

**바로 Bot 생성에 앞서 진행 전 선행조건을 만족해야합니다.** 

<br/>

#### **선행 조건**  

- **github 계정**
- **Azure 계정**

#### **사용 프레임워크**

- **Bot Framework**
- **Azure Cognitive Service API**

#### **개발 언어**

- **Python**

**Python lib**

- **microsoftbotframework** 


<br/>

---



### **1-1 FrameWork Bot 생성** <a name="a3"></a>


####  **MS에서 Python용 Sample을 이미 제공해서 수정해 쓰는걸로!!**



* **[Sample link](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python)**  


<br/>

#### **우선 Resource Group을 생성하고, Bot을 배포 할 App Service를 생성하겠습니다.**

* **다음과 같이 CLI로 Resource Group을 생성합니다.**  

    ```
    명령어 : #  az group create -l koreaCentral -n pynasa
    ```

    ![2221111](https://user-images.githubusercontent.com/69498804/118922561-3f585d80-b975-11eb-9e69-4ed3010b1be1.JPG)


<br/>


**저는 VSCODE를 주 IDE로 사용하기 때문에 VSCODE를 기반으로 App Service를 생성하겠습니다.**  
**VSCODE에서 아래 extension을 추가 설치가 필요합니다.**  
**아래 두개의 Extension을 쓰면 Azure로 Web Bot을 손쉽게 배포가 가능합니다.**  

* **Azure Account** 

    ![123123](https://user-images.githubusercontent.com/69498804/118920309-28b00780-b971-11eb-8aa7-964e271d1411.JPG)

<br/>

* **Azure App Service** 

    ![33322](https://user-images.githubusercontent.com/69498804/118920367-49785d00-b971-11eb-8df4-cfa27e1e1965.JPG)



<br/>

#### **Azure Account로 Azure 계정에 로그인 뒤 App Service를 생성합니다.**  

* **Azure Account에 정상적으로 등록되면 아래와 같이 Azure에서 구독이 보입니다.**  

    ![123123123](https://user-images.githubusercontent.com/69498804/118921566-5c8c2c80-b973-11eb-82a6-e4f748f03ba2.JPG)

    * **구독에서 우클릭 -> Create New Web App(Advanced) 선택해 생성!**  


<br/>

* **저는 pynasa 라는 이름으로 App Service를 하나 생성했습니다.**  

    **Spce** 

    * **Resouce Group : pynasa**
    * **Python 3.7** 
    * **App Service Plan : 신규 생성**   
    * **Pricing tier : S2** 
    * **Application Insitghts : Skip** 
    * **Region : Korea Central**


<br/>


* **정상적으로 생성이 되면 다음과 같으 구독아래에 App Service가 보입니다.** 

    ![323332323232332](https://user-images.githubusercontent.com/69498804/118924058-81829e80-b977-11eb-9e52-881bb1590266.JPG)

<br/>


* **실제 Azure Potal 에서도 생성 확인이 가능합니다.** 

    ![111111](https://user-images.githubusercontent.com/69498804/118924933-c8bd5f00-b978-11eb-980b-37de32ed61aa.JPG)



<br/>


#### **이제 Bot Message를 주고 받을 Channels을 생성합니다.**


* **bot Service - Bot Channels Registration**
![22222](https://user-images.githubusercontent.com/69498804/117908514-7c887400-b313-11eb-94a4-dc8109c6eb67.JPG)


<br/>

* **Channels 설정** 

    ![2222222](https://user-images.githubusercontent.com/69498804/118925207-4aad8800-b979-11eb-941f-b4196d08b0cc.JPG)

    * **Bot handle : nasapy**
    * **Resource Group : pynasa** 
    * **Location : KoreaCentral**
    * **Messaging endpoint : App Service url**
        * **App Service의 URL에 + api/massages 를 넣으면 됩니다.**  
        * **ex : https://test.azurewebsites.net/api/massages**


    * **Microsoft App ID and password : 자동생성**  

<br/>


* **Channels Resource 가 생성되었으면 Microsoft AppID를 확인합니다.** 

    ![44444](https://user-images.githubusercontent.com/69498804/118925790-42098180-b97a-11eb-9733-f0df9ec5de27.JPG)

    **APP ID는 나중에 Code 연동에 필요하니 복사해놓으세요!!**  

<br/>

* **Manage URL 클릭 -> Client secrets을 삭제 후 새로 생성**

    ![5555555](https://user-images.githubusercontent.com/69498804/118925961-8c8afe00-b97a-11eb-873f-136e3b9d6538.JPG)

    **처음 생성된 Value는 보이지가 않아서 삭제 후 새로 생성해서 복사해놓아야 합니다.**  


<br/>


#### **복사해놓은 App ID, Password 를 App Service에 등록해줍니다.**  

* **App Service - Configuration - Appliation setting**

    ![666666666666](https://user-images.githubusercontent.com/69498804/118926168-da076b00-b97a-11eb-8781-2d696fa20ce4.JPG)

    * **MicrosoftAppId : 봇채널에서 복사한 ID**
    * **MicrosoftAppPassword : 봇채널의 Value 값**  
    * **WEBSITE_HTTPLOGGING_RETENTION_DAYS : 7**
    * **WEBSITES_CONTAINER_START_TIME_LIMIT : 1400**  


<br/>


* **App Service의 Configuration - general setting**

    ![777777](https://user-images.githubusercontent.com/69498804/118926448-500bd200-b97b-11eb-8bcf-cb82f44475fc.JPG)

    * **Startup command**  
    **python3.7 -m aiohttp.web -H 0.0.0.0 -P 8000 app:init_func**  

    **해당 Stratup command가 없으면 정상적으로 동작하지 않습니다.**  

    * **웹 소켓도 열어주세요**

<br/>

---

### **자 이제 기본적인 환경세팅은 끝났습니다.**  

**드디어 코드를 볼 수 있습니다.**  
**일단 VSCODE로 작업을 위해서 위의 Sample Code를 Clone 해옵니다.**  

* **[echo bot link](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/02.echo-bot)**

* **저는 Echo Bot Sample로 다음과 같은 환경으로 만들었습니다** 

    ![999999](https://user-images.githubusercontent.com/69498804/118927047-3323ce80-b97c-11eb-823c-dce116edb9c0.JPG)


<br/>

### **소스는 app.py ,bot.py ,config.py 세 코드만 약간 수정하면 됩니다.**  

<br/>

* #### **app.py의 Code 원본**  

    ```
    import sys
    import traceback
    from datetime import datetime
    from http import HTTPStatus

    from aiohttp import web
    from aiohttp.web import Request, Response, json_response
    from botbuilder.core import (
        BotFrameworkAdapterSettings,
        TurnContext,
        BotFrameworkAdapter,
    )
    from botbuilder.core.integration import aiohttp_error_middleware
    from botbuilder.schema import Activity, ActivityTypes

    from bots import EchoBot
    from config import DefaultConfig

    CONFIG = DefaultConfig()

    # Create adapter.
    # See https://aka.ms/about-bot-adapter to learn more about how bots work.
    SETTINGS = BotFrameworkAdapterSettings(CONFIG.APP_ID, CONFIG.APP_PASSWORD)
    ADAPTER = BotFrameworkAdapter(SETTINGS)


    # Catch-all for errors.
    async def on_error(context: TurnContext, error: Exception):
        # This check writes out errors to console log .vs. app insights.
        # NOTE: In production environment, you should consider logging this to Azure
        #       application insights.
        print(f"\n [on_turn_error] unhandled error: {error}", file=sys.stderr)
        traceback.print_exc()

        # Send a message to the user
        await context.send_activity("The bot encountered an error or bug.")
        await context.send_activity(
            "To continue to run this bot, please fix the bot source code."
        )
        # Send a trace activity if we're talking to the Bot Framework Emulator
        if context.activity.channel_id == "emulator":
            # Create a trace activity that contains the error object
            trace_activity = Activity(
                label="TurnError",
                name="on_turn_error Trace",
                timestamp=datetime.utcnow(),
                type=ActivityTypes.trace,
                value=f"{error}",
                value_type="https://www.botframework.com/schemas/error",
            )
            # Send a trace activity, which will be displayed in Bot Framework Emulator
            await context.send_activity(trace_activity)


    ADAPTER.on_turn_error = on_error

    # Create the Bot
    BOT = EchoBot()


    # Listen for incoming requests on /api/messages
    async def messages(req: Request) -> Response:
        # Main bot message handler.
        if "application/json" in req.headers["Content-Type"]:
            body = await req.json()
        else:
            return Response(status=HTTPStatus.UNSUPPORTED_MEDIA_TYPE)

        activity = Activity().deserialize(body)
        auth_header = req.headers["Authorization"] if "Authorization" in req.headers else ""

        response = await ADAPTER.process_activity(activity, auth_header, BOT.on_turn)
        if response:
            return json_response(data=response.body, status=response.status)
        return Response(status=HTTPStatus.OK)


    APP = web.Application(middlewares=[aiohttp_error_middleware])
    APP.router.add_post("/api/messages", messages)

    if __name__ == "__main__":
        try:
            web.run_app(APP, host="localhost", port=CONFIG.PORT)
        except Exception as error:
            raise error
    ```

<br/>

#### **app.py는 그대로 Azure에 배포하더라도 제대로 동작하지 않습니다.**  
#### **Node.js, C#과는 다르게 APP을 실행하는 구문을 바꿔줘야 합니다.**



* **다음과 같은 식으로 맨 아래의 코드를 수정합니다.**  

    ```
    def init_func(argv):             << -- 해당 부분 함수 처리
        APP = web.Application(middlewares=[aiohttp_error_middleware])
        APP.router.add_post("/api/messages", messages)
        return APP
        
    if __name__ == "__main__":
        APP = init_func(None)             << --- 해당 부분 추가
        try:
            web.run_app(APP, host="localhost", port=CONFIG.PORT)
        except Exception as error:
            raise error
    ```

<br/>


#### **이번에는 config.py를 수정해보겠습니다.**  


<br/>

* **config.py 원본 code** 

    ```
    import os

    """ Bot Configuration """


    class DefaultConfig:
        """ Bot Configuration """

        PORT = 3978
        APP_ID = os.environ.get("MicrosoftAppId", "")
        APP_PASSWORD = os.environ.get("MicrosoftAppPassword", "")
    ```
    * **Port , App_ID, APP_Password 값 들을 모두 수정해줍니다.**  
    * **Port : 8080** 
    * **APP_ID : 아까 Channel에 넣은 ID 값**
    * **APP_PASSWORD : Value 값**  

<br/>



#### **이번에는 bot.py를 수정해보겠습니다.**  


* **bot.py 원본 Code** 

    ```
    from botbuilder.core import ActivityHandler, MessageFactory, TurnContext
    from botbuilder.schema import ChannelAccount


    class EchoBot(ActivityHandler):
        async def on_members_added_activity(
            self, members_added: [ChannelAccount], turn_context: TurnContext
        ):
            for member in members_added:
                if member.id != turn_context.activity.recipient.id:
                    await turn_context.send_activity("Hello and welcome!")

        async def on_message_activity(self, turn_context: TurnContext):
            return await turn_context.send_activity(
                MessageFactory.text(f"Echo: {turn_context.activity.text}")
            )
    ```
    **해당 코드는 Open Message와 사용자의 Massage를 Return 하는 구문입니다.**  


<br/>

* **여기서 정상동작이 가능하게 Open Message 부분만 바꾸겠습니다.**  


    ```
            for member_added in members_added:
            if member_added.id != turn_context.activity.recipient.id:
                await turn_context.send_activity("Hello I'm NaSa!")
    ```

<br/>