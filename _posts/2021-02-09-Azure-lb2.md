---
layout: post
title: "[AZURE] - LoadBalancer"
author: nasa1515
categories: AZURE
date: 2021-02-09 14:36
comments: true
cover: "/assets/1800-550.jpg"
tags: AZURE
---



## **LoadBalancer**


<br/>

**머리말**  
  

**이전 포스트에서는 L7 LB 인 Application Gateway에 대해서 정리하고 실습을 했습니다.**  
**이번에는 이어서 AZURE에서 제공하는 L4 LoadBalancer에 대해서 포스트 했습니다.**  


 
---

**Azure 시리즈**

* **이론**

    - [Subscription & management Group](https://nasa1515.github.io/azure/2021/01/21/azure.subscriptions.html)
    - [Resource & Resource Manager](https://nasa1515.github.io/azure/2021/01/22/azure-resoure.html)
    - [Azure Region & availability zones](https://nasa1515.github.io/azure/2021/01/22/azure.region.html)
    - [Azure Computing Service](https://nasa1515.github.io/azure/2021/01/25/azure.compute.html)
    - [Azure Storage](https://nasa1515.github.io/azure/2021/01/26/azure.storage.html)
    - [Azure Network VNET](https://nasa1515.github.io/azure/2021/01/26/azure-vnet.html)
    - [Azure VPN GATEWAY](https://nasa1515.github.io/azure/2021/01/27/Azure-VPN.html)
    - [Azure ExpressRoute](https://nasa1515.github.io/azure/2021/01/27/azure-expreroute.html)
    - [Azure Storage Account](https://nasa1515.github.io/azure/2021/02/08/storage2.html)


* **실습**

    - [RG 생성, Resource 생성, TAGING, Resoureces 이동하기](https://nasa1515.github.io/azure/2021/02/05/azure-resource2.html)
    - [Vnet 생성하기](https://nasa1515.github.io/azure/2021/02/05/vnet2.html)
    - [가상머신(VM)](https://nasa1515.github.io/azure/2021/02/08/VM2.html)
    - [Storage Service 생성](https://nasa1515.github.io/azure/2021/02/08/AZURE-Storageservice.html)
    - [가용성(Availability)](https://nasa1515.github.io/azure/2021/02/08/scail.html)
    - [Application Gateway](https://nasa1515.github.io/azure/2021/02/09/Azure-LB.html)


---



**목차**


- [LoadBalancer](#a1)
- [LoadBalancer 생성](#a2)
- [AG TEST!!](#a3)



--- 

<br/>

## **LoadBalancer**   <a name="a1"></a>  

<br/>


**기본적으로 Front-end로 들어오는 Inbound Traffic을 Backend-PooL로 분산하는 동작방식은**  
**이전 포스트에서 다뤘던 L7 LB인 Application Gateway와 동일합니다.**  

**다만 LoadBalancer의 알고리즘은 배포 모드에 따라 결정됩니다.**  
**기본 값은 아래 그림처럼 튜플 해시로 동작합니다**  

<br/>

* #### **Azure LoadBalancer의 동작**

    ![load-balancer-distribution](https://user-images.githubusercontent.com/69498804/107323107-0cd2d500-6ae9-11eb-8513-8a934c22f6f0.png)


<br/>

* #### **L4 LB는 아래와 같이 Public, Internal 두가지로 설정 할 수 있습니다.**    

    ![캡처2](https://user-images.githubusercontent.com/69498804/107323867-64257500-6aea-11eb-9891-5232c5802636.JPG)


    **Public LB : 외부의 트래픽을 내부로 분산시키는 역할**  
    **Internal LB : 대표 Private IP를 가지고 내부 VM의 트래픽을 분산시키는 역할**  

    * **예를 들면 Public LB단에 연결된 VM은 Web으로만 사용하고**
    * **Internal LB단은 DB 연결로만 사용해서 Private하게 설정이 가능합니다.**  


<br/>

#### **이제 LB를 생성해보면서 자세한 Option들에 대해서 설명하겠습니다!!.**

---

## **LoadBalancer 생성** <a name="a2"></a>  

<br/>

* #### **Create a Resource Tab에서 LoadBalancer를 만들어 줍니다.**
    
    ![캡처3333](https://user-images.githubusercontent.com/69498804/107325659-7ce35a00-6aed-11eb-87e6-d11e40c90b46.JPG)


    * **TYPE : 위에서 설명한 Internal, Public 두가지를 선택할 수 있습니다.**

    * **SKU (가격 계층) : Basic, Standard 두가지를 선택 할 수 있습니다.** 
        * **Basic : SLA를 지원하지 않습니다**
        * **Standard : SLA : 99.99%, 만약 AZ를 사용한다면 사용해야함.**

    * **PIP의 경우 새롭게 만들었습니다.**

<br/>



---

### **Back-end PooL 생성하기**  

<br/>

* #### **LB의 설정 Tab에서 Back-end PooL을 생성합니다.**

    ![캡처555](https://user-images.githubusercontent.com/69498804/107451079-e31dba80-6b89-11eb-8dda-0d27e4c7f556.JPG)


<br/>

* #### **추가된 backend-PooL 확인**

    ![캡처2](https://user-images.githubusercontent.com/69498804/107325960-0004b000-6aee-11eb-9e72-d27855a22a1c.JPG)

<br/>

---

### **HealthProbe [상태 프로브] 생성하기**  

<br/>

**HealthProbe는 Back-end PooL의 VM 상태를 모니터링 하는 기능입니다.**

<br/>

* **동일하게 LB의 Configure Tab에서 HealthProbe 설정을 추가합니다.**

    ![캡처3](https://user-images.githubusercontent.com/69498804/107326110-40fcc480-6aee-11eb-9539-7c9f93c3e3f6.JPG)


<br/>

### **load balancer rule [부하 분산 규칙] 생성**

<br/>

**Back-end PooL의 VM에 Traffice을 분산 시키는 방법을 정의합니다.**

<br/>

* **동일하게 LB의 Configure Tab에서 load balancer rule 설정을 추가합니다.**

    ![캡처444](https://user-images.githubusercontent.com/69498804/107326629-1b23ef80-6aef-11eb-83bd-2d4fe5f59cb5.JPG)

<br/>

### **Back-end PooL에 연결 할 VM 3대 생성**

<br/>

* **Vnet 생성하기**

    ![캡처4444](https://user-images.githubusercontent.com/69498804/107326945-a7361700-6aef-11eb-9819-598c44bebc8e.JPG)


<br/>

* **추가적으로 Vnet의 보안 설정에서 Bastion을 설정합니다.**

    ![캡처5555](https://user-images.githubusercontent.com/69498804/107327165-072cbd80-6af0-11eb-97e0-fae457b0cbae.JPG)



<br/>

* **Standard SKU를 선택했기에 3개의 영역에 VM을 각각 따로 생성하겠습니다.**  

    ![캡처22](https://user-images.githubusercontent.com/69498804/107327746-f9c40300-6af0-11eb-8640-f1b240fc9864.JPG)


<br/>

* **Network 설정에서 LB에 대한 설정을 다음과 같이 추가합니다.**

    ![캡처33](https://user-images.githubusercontent.com/69498804/107328022-6b03b600-6af1-11eb-8f21-fe7cf87031d8.JPG)


<br/>


### **OutBound Rule 설정**  


* **LB의 OutBound Rule Tab에서 Rule을 추가해줍니다.**

    ![캡처5555](https://user-images.githubusercontent.com/69498804/107329279-49a3c980-6af3-11eb-863e-976ab7b95a5a.JPG)


<br/>

* **Frontend IP address의 경우 다음과 같이 새로 만들어 줍니다.**

    ![캡처333](https://user-images.githubusercontent.com/69498804/107329112-0c3f3c00-6af3-11eb-9d5d-446193561517.JPG)


<br/>

### **OutBound PooL에 VM 추가하기**

* **LB의 Backend PooL 설정에서 생성한 OutBound에 대한 머신을 추가합니다.**

    ![캡처222](https://user-images.githubusercontent.com/69498804/107329468-8e2f6500-6af3-11eb-8153-fd59e10c37dc.JPG)

<br/>


* **다음과 같이 생성했던 VM 3대를 추가해줍니다.**

    ![캡처5555](https://user-images.githubusercontent.com/69498804/107329683-d77fb480-6af3-11eb-8a18-df96faf07cb9.JPG)


<br/>


---

<br/>

## **LB TEST**

<br/>

**TEST를 위한 IIS를 설치를 진행하겠습니다.**

* **VM 1번에 Bastion으로 접속해 Windows PowerShell을 실행합니다.**


    ![캡처333](https://user-images.githubusercontent.com/69498804/107330024-5ffe5500-6af4-11eb-8282-411e322441b2.JPG)




<br/>


* **PowerShell 창에서 아래 명령을 실행하여 다음을 수행합니다.**

    * **IIS 서버를 설치합니다.**
    * **기본 iisstart.htm 파일을 제거합니다.**
    * **VM 이름을 표시하는 새 iisstart.htm 파일을 추가합니다.**

    ```
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools

    # remove default htm file
    remove-item  C:\inetpub\wwwroot\iisstart.htm

    # Add a new htm file that displays server name
    Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)
    ```

    ![4444](https://user-images.githubusercontent.com/69498804/107333027-3fd09500-6af8-11eb-886e-30d324850e10.JPG)


<br/>

* **이후 LB의 PIP로 접속하면 정상적으로 WEB Page가 접속됩니다!**

    ![캡처333444](https://user-images.githubusercontent.com/69498804/107337984-609be900-6afe-11eb-9855-82cc54be5673.JPG)


<br/>


---


## **마치며…**  


**사실 포스트를 사용하긴 했지만 아직 Outbound Rules을 왜 설정해야하는지 이해가 되지 않습니다.**  
**추가적으로 포스트하다가 개념에 대해서 깨닫게 되면 수정하겠습니다.**  



